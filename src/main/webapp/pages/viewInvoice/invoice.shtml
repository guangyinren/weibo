<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>票通电子发票服务平台</title>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <link rel="shortcut icon" href="/images/viewInvoice/favicon.ico">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="/css/viewInvoice/sm.min.css">
    <link rel="stylesheet" href="/css/viewInvoice/scale.css"/>
    <link rel="stylesheet" href="/css/viewInvoice/style.css">
    <script type='text/javascript' src='/js/viewInvoice/vue.min.js' charset='utf-8'></script>
    <script type='text/javascript' src='/js/viewInvoice/vue-resource.min.js' charset='utf-8'></script>
    <script type='text/javascript' src='/js/viewInvoice/vpiaotong.base.js' charset='utf-8'></script>
    <script type='text/javascript' src='/js/viewInvoice/vpiaotong.util.js' charset='utf-8'></script>
</head>
<body>
<div class="page-group" id="myApp">
    <div class="page page-current">
        <div class="content native-scroll">
            <div class="content-inner view-invoice-content" id="image">
                <img class="shadow-666" :src="src"/>
                <img class="view-invoice-red-mark" src="/images/viewInvoice/red-mark.png" v-if="isAlreadyRed">
            </div>
        </div>
        <section class="imgzoom_pack" v-if="!isAlreadyRed">
            <div class="imgzoom_x">X</div>
            <div class="imgzoom_img"><img src=""/></div>
        </section>
        <div class="bar-standard bar-footer footer-content" v-if="!isAlreadyRed">
            <a class="button button-fill footer-button2" @click="downloadInvoice" v-if="isAndroid">下载电子发票PDF文件</a>
            <a class="button button-fill footer-button2" @click="collectionInvoice"
               v-if="collectionInvoiceFlag">电子发票归集</a>
            <a class="button button-fill footer-button1" @click="sendInvoice">发送电子发票到邮箱</a>
        </div>
    </div>
</div>
<script type='text/javascript' src='/js/viewInvoice/zepto.min.js' charset='utf-8'></script>
<script type='text/javascript' src='/js/viewInvoice/sm.min.js' charset='utf-8'></script>
<script type='text/javascript' src="/js/viewInvoice/scale.js" charset='utf-8'></script>
<script>
    new Vue({
        el: '#myApp',
        data: {
            state: '',
            src: '',
            collectionInvoiceFlag: false,
            chbz: ''
        },
        created: function () {
            var parameter = JSON.parse(decodeURIComponent($Utils.getUrlParameters().state));
            if ($Utils.isNotEmptyObject(parameter)) {
                this.state = parameter.state;
                this.src = basePath + 'invoice/view/getElectronicInvoiceImage' + suffix + '?state=' + parameter.state;
                this.collectionInvoiceFlag = parameter.flag;
                this.chbz = parameter.data;
            } else {
                window.location.href = basePath + 'pages/viewInvoice/error-404.shtml';
            }
        },
        methods: {
            collectionInvoice: function () {
                var that = this;
                $.actions([[
                    {
                        text: '加入微信卡包',
                        onClick: function () {
                            $.showIndicator();
                            that.$http.get(basePath + 'invoice/view/getWeChatAuthUrl' + suffix, {
                                params: {
                                    state: that.state
                                }
                            }).then(function (response) {
                                $.hideIndicator();
                                if (response.body.code === '200') {
                                    window.location.href = response.body.data.data;
                                } else {
                                    window.location.href = basePath + 'pages/viewInvoice/error-404.shtml';
                                }
                            }).catch(function (error) {
                                $.hideIndicator();
                                window.location.href = basePath + 'pages/viewInvoice/error-500.shtml';
                            });

                        }
                    },
                    {
                        text: '添加到支付宝发票管家',
                        onClick: function () {
                            $.showIndicator();
                            that.$http.get(basePath + 'invoice/view/getAlipayAuthUrl' + suffix, {
                                params: {
                                    state: that.state
                                }
                            }).then(function (response) {
                                $.hideIndicator();
                                if (response.body.code === '200') {
                                    window.location.href = 'alipays://platformapi/startapp?appId=20000067&action=WebView&url=' + encodeURIComponent(response.body.data.data);
                                } else {
                                    window.location.href = basePath + 'pages/viewInvoice/error-404.shtml';
                                }
                            }).catch(function (error) {
                                $.hideIndicator();
                                window.location.href = basePath + 'pages/viewInvoice/error-500.shtml';
                            });
                        }
                    }
                ], [
                    {
                        text: '取消'
                    }
                ]]);
            },
            sendInvoice: function () {
                window.location.href = basePath + 'pages/viewInvoice/invoice-send.shtml?state=' + this.state;
            },
            downloadInvoice: function () {
                window.location.href = basePath + 'invoice/view/getElectronicInvoice' + suffix + '?state=' + this.state;
            }
        },
        computed: {
            isAndroid: function () {
                return $Utils.getBrowser().versions.android;
            },
            isAlreadyRed: function () {
                return this.chbz === 'ALREADY_RED';
            }
        },
        mounted: function () {
            if (!this.isAlreadyRed) {
                ImagesZoom.init({
                    'elem': '#image'
                });
            }
            $.init();
        }
    });
</script>
</body>
</html>